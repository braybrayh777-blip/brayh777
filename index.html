<script>
    let coresReady = false;
    let coreDataUrl = null;
    let coreJsUrl = null;
    let coreWasmUrl = null;

    async function preloadCores() {
        const files = [
            { key: 'data', path: '/brayh777/data/cores/mgba-legacy-wasm-data.txt' },
            { key: 'js', path: '/brayh777/data/cores/mgba-legacy-wasm-js.txt' },
            { key: 'wasm', path: '/brayh777/data/cores/mgba-legacy-wasm-wasm.txt' }
        ];

        for (const file of files) {
            try {
                const res = await fetch(file.path);
                if (!res.ok) {
                    console.error(`Failed to fetch ${file.path}: ${res.status} ${res.statusText}`);
                    continue;
                }
                const base64 = await res.text();
                const binary = atob(base64);
                const bytes = new Uint8Array(binary.length);
                for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
                const blob = new Blob([bytes], { type: 'application/octet-stream' });
                const url = URL.createObjectURL(blob);

                if (file.key === 'data') coreDataUrl = url;
                if (file.key === 'js') coreJsUrl = url;
                if (file.key === 'wasm') coreWasmUrl = url;

                console.log(`Core ${file.key} decoded OK: ${url.substring(0, 50)}...`);
            } catch (e) {
                console.error(`Core preload failed for ${file.path}`, e);
            }
        }
        coresReady = true;
        console.log('Cores preloaded');
    }

    preloadCores();

    function loadGame(core, romPath, gameName) {
        document.getElementById('hub').style.display = 'none';
        document.getElementById('game-container').style.display = 'block';

        const emu = document.getElementById('emulator');
        emu.innerHTML = '<p style="color:#0f0;">Loading ROM... (may take 30–90 seconds)</p>';

        if (!coresReady) {
            emu.innerHTML += '<p style="color:#ff0;">Waiting for cores...</p>';
            setTimeout(() => loadGame(core, romPath, gameName), 2000);
            return;
        }

        const romUrl = romPath; // direct path

        window.EJS_player = '#emulator';
        window.EJS_core = core;
        window.EJS_pathtodata = '/brayh777/data/';
        window.EJS_gameUrl = romUrl;
        window.EJS_gameName = gameName;
        window.EJS_startOnLoad = true;

        // Force use of our preloaded Blobs (bypass broken report/fetch)
        window.EJS_coreUrl = coreJsUrl; // direct JS Blob for core logic
        window.EJS_coreWasmUrl = coreWasmUrl; // WASM Blob
        window.EJS_coreDataUrl = coreDataUrl; // Data Blob

        console.log('Starting emulator with ROM:', romUrl);

        const s = document.createElement('script');
        s.src = '/brayh777/data/loader.js';
        s.onload = () => {
            console.log('Loader loaded – waiting for core registration');
            setTimeout(() => {
                if (window.EJS_emulator && typeof window.EJS_emulator.start === 'function') {
                    window.EJS_emulator.start();
                    console.log('Game start called successfully');
                } else {
                    console.error('EJS_emulator.start not available after delay');
                    emu.innerHTML += '<p style="color:red;">Core registration failed - check console</p>';
                }
            }, 12000); // 12-second delay
        };
        s.onerror = () => emu.innerHTML = '<p style="color:red;">Loader failed</p>';
        document.body.appendChild(s);
    }

    function closeGame() {
        document.getElementById('game-container').style.display = 'none';
        document.getElementById('hub').style.display = 'block';
        document.getElementById('emulator').innerHTML = '';
    }
</script>
